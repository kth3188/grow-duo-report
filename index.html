<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GROW-DUO ì½”ì¹­ ë¦¬í¬íŠ¸</title>
    
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React ë° Babel ë¡œë“œ -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase SDK ë¡œë“œ -->
    <script type="module">
        // Firebase v9+ ëª¨ë“ˆ ë°©ì‹ import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ì „ì—­ ë³€ìˆ˜ë¡œ í• ë‹¹í•˜ì—¬ React ì»´í¬ë„ŒíŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ í•¨
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            getFirestore,
            collection,
            addDoc,
            getDocs,
            query,
            where,
            serverTimestamp
        };
    </script>

    <style>
        /* ê¸°ë³¸ í°íŠ¸ ë° ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        .animate-fade-in-fast {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .prose ul {
            list-style-position: outside;
            padding-left: 1.5rem;
        }
        .prose li {
            padding-left: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- í•œê¸€ í°íŠ¸(D2Coding) ë°ì´í„° ---
        const D2Coding = "AAEAAAARAQAABAAQR0RFRgQsBBMAAAE4AAAAHkdQT1O1LhjsAAAEsAAAAGJHU1VCW2gAAAACAAAAZAAAAENPU1QAAgAAAAIAAAAzAAAAA09TLzJDAFArAAABgAAAAFZjbWFwDS4FtgAAAqAAAAI0Z2FyaQAAAAEAAAEKAAAAAWZwZ21g3wZgAAAFkAAAAXJnbHlm/fV7sQAAAYwAAADkaGVhZBk96K0AAADcAAAANmhoZWEH3gOFAAABFAAAACRobXR4BEAAAAAAAbAAAAAgbG9jYQAKADgAAAMEAAAADm1heHABGgBuAAABOAAAACBuYW1lAEoApAAABiAAAAJxcG9zdAABAAAAAAMgAAAACQAGAAMAAQAAAAEAAQAAARIAAAADAAAAAwABAAQAAAABAAQABAABAAAAAQAAAAgAAAAGAAAAAwABBAcAAAAAAAQABAABAAAAAQAAAAgAAAAGAAAAAwABBAkAAAAAAAQABAABAAAAAQAAAAgAAAAGAAAAAwABBAoAAAAAAAQABAABAAAAAQAAAAgAAAAGAAAAAwABBDMAAAAAAAQABAABAAAAAQAAAAgAAAAGAAAAAwABBDQAAAAAAAQABAABAAAAAQAAAAgAAAAGAAAAAwABBDUAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGgAAAAEAAAAAAAEAAAABAACAAGg-AAA";

        // --- Firebase ì„¤ì • ---
        // ì´ ì„¤ì • ì •ë³´ëŠ” Canvas í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
        // ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œì—ëŠ” ë³¸ì¸ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì •ìœ¼ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

        // --- ì½”ì¹­ ê°€ì´ë“œ ë°ì´í„° ---
        const coachingGuides = {
          goal: {
            title: "ëª©í‘œ ì„¤ì • (Goal)",
            questions: [
              "ì§€ê¸ˆ ì´ ì‹œê°„ ìƒë‹´ì—ì„œ ë¬´ì—‡ì„ ì–»ê³  ì‹¶ë‚˜ìš”?",
              "ì•ìœ¼ë¡œ ì–´ë–¤ ëª¨ìŠµì„ ì´ë£¨ê³  ì‹¶ë‚˜ìš”? êµ¬ì²´ì ìœ¼ë¡œ ë¬´ì—‡ì´ ë³€í™”ë˜ì—ˆìœ¼ë©´ ì¢‹ê² ë‚˜ìš”?",
              "ìµœê·¼ì— ê°€ì¥ ìë‘ìŠ¤ëŸ¬ì› ë˜ ì„±ì·¨ëŠ” ë¬´ì—‡ì´ì—ˆë‚˜ìš”? ê·¸ ê²½í—˜ì„ ì•ìœ¼ë¡œ ì–´ë–»ê²Œ ì‚´ë¦´ ìˆ˜ ìˆì„ê¹Œìš”?",
              "ë‹¹ì‹ ì˜ ê°•ì ì´ ì˜ ë°œíœ˜ë˜ëŠ” ìƒí™©ì—ì„œ ì–´ë–¤ ëª©í‘œë¥¼ ì„¸ì›Œë³´ê³  ì‹¶ë‚˜ìš”?",
            ],
            tips: [
              "ì—´ë¦° ì§ˆë¬¸ìœ¼ë¡œ êµ¬ì²´ì  ëª©í‘œ ë„ì¶œ ìœ ë„",
              "ê³¼ê±° ì„±ì·¨ ê²½í—˜ íƒìƒ‰ ë° ê¸ì •ì  ê°•í™”",
              "ê°•ì (ì„±ê³µ ê²½í—˜, íŠ¹ì„±, ìì›)ì— ì£¼ëª©í•˜ë©° ëª©í‘œì™€ ì—°ê²°",
            ],
          },
          reality: {
            title: "í˜„ì‹¤ ì ê²€ (Reality)",
            questions: [
              "í˜„ì¬ ìƒí™©ì€ ì–´ë–¤ê°€ìš”? ì´ë²ˆ ëª©í‘œì™€ ê´€ë ¨í•´ ì–´ë ¤ì›€ì´ë‚˜ ë„ì „ ê³¼ì œëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
              "ì§€ê¸ˆ ë‹¹ì‹ ì´ ê°€ì§„ ê°€ì¥ í° ê°•ì ì€ ë¬´ì—‡ì´ë¼ê³  ìƒê°í•˜ë‚˜ìš”? ê·¸ ê°•ì ì„ ìµœê·¼ ì–´ë””ì— ì–´ë–»ê²Œ ì‚¬ìš©í–ˆë‚˜ìš”?",
              "ì´ë¯¸ ì‹œë„í•´ë³¸ ë°©ë²•, ê¸ì •ì ìœ¼ë¡œ ë³€í™”ëœ ì ì´ ìˆì—ˆë‹¤ë©´ ë¬´ì—‡ì¸ê°€ìš”?",
              "ì„±ì·¨ ê²½í—˜ì„ ë˜ì§šì–´ë³¼ ë•Œ, íŠ¹ë³„íˆ ì˜í–ˆë˜ ì ì€ ë¬´ì—‡ì¸ê°€ìš”?",
            ],
            tips: [
              "í˜„ ìƒí™©ì— ëŒ€í•œ ê°ê´€ì  ì¸ì‹ ë„ëª¨",
              "ê°•ì  ë° ê¸ì •ì  ìì› ë°œê²¬ì„ ìœ„í•œ ë°˜ì¶”ì  ëŒ€í™”",
              "íŒë‹¨ ì—†ì´ ê²½ì²­, ë°ì´í„°Â·ì‚¬ì‹¤ ê¸°ë°˜ í”¼ë“œë°± ì œì‹œ",
            ],
          },
          options: {
            title: "ëŒ€ì•ˆ íƒìƒ‰ (Options)",
            questions: [
              "ëª©í‘œë¥¼ ì´ë£¨ê¸° ìœ„í•´ ì‹œë„í•´ë³¼ ìˆ˜ ìˆëŠ” ë°©ë²•ì—ëŠ” ì–´ë–¤ ê²ƒë“¤ì´ ìˆì„ê¹Œìš”?",
              "ë‹¹ì‹ ì˜ ê°•ì ì„ í™œìš©í•˜ë©´ ì–´ë–¤ ìƒˆë¡œìš´ í•´ê²°ì±…ì´ ë‚˜ì˜¬ ìˆ˜ ìˆì„ê¹Œìš”?",
              "ì˜ˆì „ì— ê°•ì ì„ ì´ìš©í•´ì„œ ì–´ë ¤ì›€ì„ ê·¹ë³µí•œ ê²½í—˜ì´ ìˆì—ˆë‚˜ìš”? ê·¸ ê²½í—˜ì„ ì´ë²ˆì—ë„ ì‚¬ìš©í•  ìˆ˜ ìˆì„ê¹Œìš”?",
              "ë§Œì•½ ì•„ë¬´ëŸ° ì œì•½ì´ ì—†ë‹¤ë©´ ë¬´ì—‡ì„ í•´ë³´ê³  ì‹¶ë‚˜ìš”?",
            ],
            tips: [
              "ë¸Œë ˆì¸ìŠ¤í† ë° ê¸°ë²• í™œìš© ë° ì œì•½ ì—†ëŠ” ì‚¬ê³  ê°•ì¡°",
              "ê°•ì  ì¤‘ì‹¬ì˜ ëŒ€ì•ˆê³¼ ë‹¤ì–‘í•œ ì„ íƒì§€ íƒìƒ‰ ë…ë ¤",
              "ì‹¤í˜„ ê°€ëŠ¥ì„±ê³¼ ë³¸ì¸ ì˜ì§€ì˜ ê· í˜• ì ê²€",
            ],
          },
          will: {
            title: "ì‹¤í–‰ ê³„íš (Will)",
            questions: [
              "ì§€ê¸ˆ ë‹¹ì¥ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” ì²« ë²ˆì§¸ í–‰ë™ì€ ë¬´ì—‡ì¼ê¹Œìš”?",
              "ì´ í–‰ë™ê³„íšì„ ì‹¤ì²œí•  ë•Œ, ë‹¹ì‹ ì˜ ì–´ë–¤ ê°•ì ì´ ë„ì›€ì´ ë  ê²ƒ ê°™ë‚˜ìš”?",
              "ê³„íšì„ ì‹¤í–‰í•  ë•Œ ì¥ì• ë¬¼ì´ ì˜ˆìƒëœë‹¤ë©´, ê·¸ë•Œ ì–´ë–»ê²Œ ê°•ì ì„ í™œìš©í•  ìˆ˜ ìˆì„ê¹Œìš”?",
              "ì‹¤í–‰ì— ì„±ê³µí–ˆì„ ë•Œ, ìì‹ ì„ ì–´ë–»ê²Œ ì¹­ì°¬í•´ì£¼ê³  ì‹¶ë‚˜ìš”?",
            ],
            tips: [
              "êµ¬ì²´ì  í–‰ë™ê³„íš ìˆ˜ë¦½(5W1H)",
              "ì‹¤í–‰ ì˜ì§€ í™•ì¸ ë° ê°•ì -ì‹¤í–‰ ì—°ê²°",
              "ì‹¤í–‰ í›„ í”¼ë“œë°±/ìê¸°ê°•í™” ì „ëµ ë§ˆë ¨",
            ],
          },
        };


        // --- ë©”ì¸ App ì»´í¬ë„ŒíŠ¸ ---
        function App() {
            const [page, setPage] = useState('start');
            const [reportData, setReportData] = useState(null);
            const [analysisResult, setAnalysisResult] = useState(null);
            const [globalError, setGlobalError] = useState('');
            const [firebaseServices, setFirebaseServices] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            // Firebase ì´ˆê¸°í™” ë° ì¸ì¦
            useEffect(() => {
                try {
                    const { 
                        initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore 
                    } = window.firebase;

                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    setFirebaseServices({ app, auth, db });

                    onAuthStateChanged(auth, user => {
                        if (user) {
                            console.log("ì¸ì¦ëœ ì‚¬ìš©ì:", user.uid);
                            setIsAuthReady(true);
                        } else {
                            signInAnonymously(auth).catch(error => {
                                console.error("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                                showGlobalError("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            });
                        }
                    });
                } catch (error) {
                    console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                    showGlobalError("ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            }, []);


            const showGlobalError = (message) => {
                setGlobalError(message);
                setTimeout(() => setGlobalError(''), 4000);
            };

            const handleStart = (mode, studentInfo) => {
                if (mode === 'analysis') {
                    setPage('analysis');
                } else {
                    setReportData({ studentInfo, growData: null });
                    setPage(mode);
                }
            };

            const handleComplete = (growData) => {
                setReportData(prev => ({ ...prev, growData }));
                setPage('report');
            };

            const handleAnalysisComplete = (result) => {
                setAnalysisResult(result);
                setPage('analysis_report');
            };

            const handleReset = () => {
                setReportData(null);
                setAnalysisResult(null);
                setPage('start');
            };

            const renderPage = () => {
                if (!isAuthReady && page !== 'start') {
                    return <div className="text-center p-10">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-900 mx-auto"></div>
                        <p className="mt-4 text-slate-600">ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...</p>
                    </div>;
                }

                switch (page) {
                    case 'counseling':
                        return <CounselingMode onComplete={handleComplete} studentInfo={reportData.studentInfo} />;
                    case 'logging':
                        return <LoggingMode onComplete={handleComplete} studentInfo={reportData.studentInfo} />;
                    case 'analysis':
                        return <CumulativeAnalysisMode onComplete={handleAnalysisComplete} onBack={handleReset} db={firebaseServices.db} onError={showGlobalError} />;
                    case 'report':
                        return <FinalReport data={reportData} onReset={handleReset} onError={showGlobalError} db={firebaseServices.db} />;
                    case 'analysis_report':
                        return <AnalysisReport result={analysisResult} onReset={handleReset} />;
                    case 'start':
                    default:
                        return <StartScreen onStart={handleStart} />;
                }
            };

            return (
                <div className="bg-slate-100 min-h-screen font-sans flex items-center justify-center p-4">
                    <div className="w-full max-w-4xl bg-white rounded-2xl shadow-lg p-6 md:p-10 transition-all duration-500 relative">
                        {globalError && (
                            <div className="absolute top-5 right-5 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-20 animate-fade-in">
                                <strong className="font-bold">ì˜¤ë¥˜: </strong>
                                <span className="block sm:inline">{globalError}</span>
                            </div>
                        )}
                        {renderPage()}
                    </div>
                </div>
            );
        }

        // --- 1. ì‹œì‘ í™”ë©´ ì»´í¬ë„ŒíŠ¸ ---
        function StartScreen({ onStart }) {
            const [studentName, setStudentName] = useState('');
            const [session, setSession] = useState(1);
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [message, setMessage] = useState('');

            const canStart = studentName.trim() !== '' && session > 0;

            const handleStartClick = (mode) => {
                if (!canStart && mode !== 'analysis') {
                    setMessage('í•™ìƒ ì´ë¦„ê³¼ ìƒë‹´ íšŒì°¨ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    setTimeout(() => setMessage(''), 3000);
                    return;
                }
                const studentInfo = { name: studentName.trim(), session, date };
                onStart(mode, studentInfo);
            };

            return (
                <div className="text-center animate-fade-in">
                    <h1 className="text-3xl md:text-4xl font-bold text-slate-800 mb-2">GROW-DUO ì½”ì¹­ ë¦¬í¬íŠ¸</h1>
                    <p className="text-slate-500 mb-8">ìƒë‹´ì„ ê¸°ë¡í•˜ê±°ë‚˜, ê³¼ê±° ê¸°ë¡ì„ ë¶„ì„í•´ë³´ì„¸ìš”.</p>

                    <div className="bg-slate-50 p-6 rounded-xl mb-8">
                        <h3 className="text-xl font-semibold text-slate-700 mb-4">ìƒˆ ìƒë‹´ ê¸°ë¡í•˜ê¸°</h3>
                        <div className="space-y-4 max-w-md mx-auto">
                            <input type="text" placeholder="í•™ìƒ ì´ë¦„" value={studentName} onChange={(e) => setStudentName(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" />
                            <div className="flex gap-4">
                                <input type="number" placeholder="ìƒë‹´ íšŒì°¨" value={session} onChange={(e) => setSession(Math.max(1, parseInt(e.target.value) || 1))} className="w-1/2 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" />
                                <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-1/2 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" />
                            </div>
                        </div>
                        {message && <p className="text-red-500 mt-4">{message}</p>}
                        <div className="flex flex-col md:flex-row gap-4 justify-center mt-6">
                            <button onClick={() => handleStartClick('counseling')} disabled={!canStart} className="w-full md:w-auto flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 disabled:bg-slate-300 disabled:cursor-not-allowed disabled:transform-none">
                                ğŸ’¬ ìƒë‹´ ëª¨ë“œ
                            </button>
                            <button onClick={() => handleStartClick('logging')} disabled={!canStart} className="w-full md:w-auto flex-1 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-transform transform hover:scale-105 disabled:bg-slate-300 disabled:cursor-not-allowed disabled:transform-none">
                                âœï¸ ê¸°ë¡ ëª¨ë“œ
                            </button>
                        </div>
                    </div>

                    <div className="bg-indigo-50 p-6 rounded-xl">
                        <h3 className="text-xl font-semibold text-slate-700 mb-4">ê³¼ê±° ê¸°ë¡ ë¶„ì„í•˜ê¸°</h3>
                        <p className="text-slate-500 mb-4 text-sm">í´ë¼ìš°ë“œì— ì €ì¥ëœ ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì™€ ëˆ„ì  ë¶„ì„ì„ ì§„í–‰í•©ë‹ˆë‹¤.</p>
                        <button onClick={() => handleStartClick('analysis')} className="w-full md:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105">
                            ğŸ“ˆ ëˆ„ì  ë¶„ì„ ëª¨ë“œ
                        </button>
                    </div>
                </div>
            );
        }

        // --- 2. ìƒë‹´ ëª¨ë“œ ì»´í¬ë„ŒíŠ¸ (ë‹¨ê³„ë³„ ì›Œí¬í”Œë¡œìš° ì ìš©) ---
        function CounselingMode({ onComplete, studentInfo }) {
            const [step, setStep] = useState(1);
            const [growData, setGrowData] = useState({
                goal: '',
                reality: { strengths: [], challenges: [] },
                options: [''],
                will: ''
            });

            const nextStep = () => setStep(s => Math.min(s + 1, 4));
            const prevStep = () => setStep(s => Math.max(s - 1, 1));

            const updateField = (field, value) => {
                setGrowData(prev => ({ ...prev, [field]: value }));
            };

            const updateReality = (type, value) => {
                setGrowData(prev => ({
                    ...prev,
                    reality: { ...prev.reality, [type]: value }
                }));
            };

            const handleOptionChange = (index, value) => {
                const newOptions = [...growData.options];
                newOptions[index] = value;
                setGrowData(prev => ({ ...prev, options: newOptions }));
            };

            const addOption = () => setGrowData(prev => ({ ...prev, options: [...prev.options, ''] }));
            
            const removeOption = (index) => {
                if (growData.options.length > 1) {
                    const newOptions = growData.options.filter((_, i) => i !== index);
                    setGrowData(prev => ({ ...prev, options: newOptions }));
                }
            };

            const handleSubmit = () => {
                const finalData = {
                    ...growData,
                    options: growData.options.filter(o => o.trim() !== '')
                };
                onComplete(finalData);
            };

            const steps = [
                { key: 'goal', title: 'Goal (ëª©í‘œ ì„¤ì •)' },
                { key: 'reality', title: 'Reality (í˜„ì‹¤ ì ê²€)' },
                { key: 'options', title: 'Options (ëŒ€ì•ˆ íƒìƒ‰)' },
                { key: 'will', title: 'Will (ì‹¤í–‰ ê³„íš)' }
            ];

            return (
                <div className="animate-fade-in">
                    <h2 className="text-2xl font-bold text-slate-800 mb-1">ğŸ’¬ ìƒë‹´ ëª¨ë“œ: {studentInfo.name}</h2>
                    <p className="text-slate-500 mb-6">{steps[step - 1].title}</p>

                    {/* Progress Bar */}
                    <div className="w-full bg-gray-200 rounded-full h-2.5 mb-8">
                        <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${(step / 4) * 100}%`, transition: 'width 0.5s ease-in-out' }}></div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {/* Left side: Input fields */}
                        <div className="space-y-6">
                            {step === 1 && (
                                <div>
                                    <label className="font-bold text-slate-700">í•™ìƒì˜ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”?</label>
                                    <textarea value={growData.goal} onChange={e => updateField('goal', e.target.value)} className="w-full mt-2 p-2 border rounded-lg" rows="5" placeholder="í•™ìƒì˜ ëª©í‘œë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                                </div>
                            )}
                            {step === 2 && (
                                <div>
                                    <label className="font-bold text-slate-700">í•™ìƒì˜ í˜„ì¬ ìƒí™©ì€ ì–´ë–¤ê°€ìš”?</label>
                                    <div className="mt-2 p-3 bg-slate-50 rounded-lg space-y-4">
                                        <div>
                                            <h4 className="font-semibold text-slate-600">ê°•ì  / ê¸ì •ì  ì¸¡ë©´</h4>
                                            <input type="text" value={growData.reality.strengths.join(', ')} onChange={e => updateReality('strengths', e.target.value.split(',').map(s => s.trim()))} className="w-full mt-1 p-2 border rounded-lg" placeholder="ì‰¼í‘œ(,)ë¡œ ê°•ì ì„ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”." />
                                        </div>
                                        <div>
                                            <h4 className="font-semibold text-slate-600">ì–´ë ¤ì›€ / ê°œì„ ì </h4>
                                            <input type="text" value={growData.reality.challenges.join(', ')} onChange={e => updateReality('challenges', e.target.value.split(',').map(s => s.trim()))} className="w-full mt-1 p-2 border rounded-lg" placeholder="ì‰¼í‘œ(,)ë¡œ ì–´ë ¤ì›€ì„ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”." />
                                        </div>
                                    </div>
                                </div>
                            )}
                            {step === 3 && (
                                <div>
                                    <label className="font-bold text-slate-700">ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•´ ì–´ë–¤ ë°©ë²•ë“¤ì´ ìˆì„ê¹Œìš”?</label>
                                    {growData.options.map((option, index) => (
                                        <div key={index} className="flex items-center gap-2 mt-2">
                                            <input type="text" value={option} onChange={e => handleOptionChange(index, e.target.value)} className="w-full p-2 border rounded-lg" placeholder={`ëŒ€ì•ˆ ${index + 1}`} />
                                            <button onClick={() => removeOption(index)} className={`text-red-500 hover:text-red-700 text-xl font-bold ${growData.options.length <= 1 ? 'invisible' : ''}`}>&times;</button>
                                        </div>
                                    ))}
                                    <button onClick={addOption} className="mt-2 text-sm text-blue-600 hover:underline">+ ëŒ€ì•ˆ ì¶”ê°€</button>
                                </div>
                            )}
                            {step === 4 && (
                                <div>
                                    <label className="font-bold text-slate-700">êµ¬ì²´ì ì¸ ì‹¤í–‰ ê³„íšì€ ë¬´ì—‡ì¸ê°€ìš”?</label>
                                    <textarea value={growData.will} onChange={e => updateField('will', e.target.value)} className="w-full mt-2 p-2 border rounded-lg" rows="5" placeholder="êµ¬ì²´ì ì¸ ì‹¤í–‰ ê³„íšì„ ì…ë ¥í•˜ì„¸ìš”. (ë¬´ì—‡ì„, ì–¸ì œ, ì–´ë–»ê²Œ)"></textarea>
                                </div>
                            )}
                        </div>

                        {/* Right side: Coaching Guide */}
                        <CoachingGuide guide={coachingGuides[steps[step - 1].key]} />
                    </div>

                    {/* Navigation Buttons */}
                    <div className="flex justify-between mt-8">
                        <button onClick={prevStep} disabled={step === 1} className="bg-slate-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-600 transition disabled:bg-slate-300 disabled:cursor-not-allowed">ì´ì „</button>
                        {step < 4 && <button onClick={nextStep} className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">ë‹¤ìŒ</button>}
                        {step === 4 && <button onClick={handleSubmit} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">ì‘ì„± ì™„ë£Œ</button>}
                    </div>
                </div>
            );
        }

        // --- 2-1. ì½”ì¹­ ê°€ì´ë“œ ì»´í¬ë„ŒíŠ¸ ---
        function CoachingGuide({ guide }) {
            return (
                <div className="bg-slate-50 p-4 rounded-lg border">
                    <h3 className="text-lg font-bold text-slate-700 mb-3">{guide.title} ê°€ì´ë“œ</h3>
                    <div className="space-y-4">
                        <div>
                            <h4 className="font-semibold text-slate-600">ğŸ’¡ í•µì‹¬ ì§ˆë¬¸ ì˜ˆì‹œ</h4>
                            <ul className="list-disc list-inside text-slate-600 text-sm mt-1 space-y-1">
                                {guide.questions.map((q, i) => <li key={i}>{q}</li>)}
                            </ul>
                        </div>
                        <div>
                            <h4 className="font-semibold text-slate-600">ğŸ› ï¸ ì½”ì¹­ ê¸°ìˆ  íŒ</h4>
                            <ul className="list-disc list-inside text-slate-600 text-sm mt-1 space-y-1">
                                {guide.tips.map((tip, i) => <li key={i}>{tip}</li>)}
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }


        // --- 3. ê¸°ë¡ ëª¨ë“œ ì»´í¬ë„ŒíŠ¸ (AI í”„ë¡¬í”„íŠ¸ ìˆ˜ì •) ---
        function LoggingMode({ onComplete, studentInfo }) {
            const [text, setText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            const handleAnalyze = async () => {
                if (text.trim() === '') {
                    setError('ìƒë‹´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                setIsLoading(true);
                setError('');

                const prompt = `
                    You are an expert school counselor's assistant. Analyze the following counseling transcript and structure it into a GROW model JSON format.
                    The JSON object must have these keys: "goal" (string), "reality" (object with "strengths" and "challenges" as string arrays), "options" (string array), "will" (string), and "nextSessionQuestions" (an array of 3-4 insightful, open-ended follow-up questions in Korean for the next counseling session, based on the current session's content).
                    If any information for a key is missing from the text, use an empty string or an empty array.
                    The entire response must be only the JSON object, with no other text or explanations.
                    The language of the output values in the JSON should be Korean.

                    --- Counseling Transcript ---
                    ${text}
                    --- End Transcript ---
                `;

                try {
                    const apiKey = ""; // ì—¬ê¸°ì— Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API request failed: ${response.statusText}`);

                    const result = await response.json();
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedData = JSON.parse(jsonText);

                    const growData = {
                        goal: parsedData.goal || '',
                        reality: {
                            strengths: Array.isArray(parsedData.reality?.strengths) ? parsedData.reality.strengths : [],
                            challenges: Array.isArray(parsedData.reality?.challenges) ? parsedData.reality.challenges : [],
                        },
                        options: Array.isArray(parsedData.options) ? parsedData.options : [],
                        will: parsedData.will || '',
                        nextSessionQuestions: Array.isArray(parsedData.nextSessionQuestions) ? parsedData.nextSessionQuestions : []
                    };

                    onComplete(growData);

                } catch (e) {
                    console.error("AI analysis error:", e);
                    setError("AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="animate-fade-in">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6">âœï¸ ê¸°ë¡ ëª¨ë“œ: {studentInfo.name}</h2>
                    <p className="text-slate-600 mb-4">ìƒë‹´ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. AIê°€ GROW ëª¨ë¸ì— ë§ì¶° ìë™ìœ¼ë¡œ ì •ë¦¬í•˜ê³ , ë‹¤ìŒ íšŒì°¨ ì§ˆë¬¸ê¹Œì§€ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤.</p>
                    <textarea
                        value={text}
                        onChange={(e) => setText(e.target.value)}
                        className="w-full h-64 p-3 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-green-500"
                        placeholder="ì˜ˆì‹œ) ì˜¤ëŠ˜ OOí•™ìƒê³¼ ì´ì•¼ê¸°í–ˆëŠ”ë°, ìˆ˜í•™ ì„±ì ì„ ì˜¬ë¦¬ê³  ì‹¶ì–´í•˜ì§€ë§Œ(Goal) ìš”ì¦˜ ê²Œì„ì— ë„ˆë¬´ ë§ì€ ì‹œê°„ì„ ì“°ê³  ìˆì–´ì„œ(Reality) ê³ ë¯¼ì´ë¼ê³  í–ˆë‹¤. í•™ì›ì— ê°€ê±°ë‚˜ ì¹œêµ¬ì™€ ìŠ¤í„°ë””ë¥¼ í•˜ëŠ” ë°©ë²•(Options)ì„ ìƒê° ì¤‘ì¸ë°, ì¼ë‹¨ ì˜¤ëŠ˜ë¶€í„° ë°¤ 10ì‹œ ì´í›„ì—ëŠ” ê²Œì„ì„ ì•ˆ í•˜ê¸°ë¡œ ì•½ì†í–ˆë‹¤(Will)."
                    />
                    {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    <button onClick={handleAnalyze} disabled={isLoading} className="w-full mt-4 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition disabled:bg-slate-400 disabled:cursor-wait">
                        {isLoading ? 'AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...' : 'AIë¡œ ë¶„ì„í•˜ê¸°'}
                    </button>
                </div>
            );
        }

        // --- 4. ëˆ„ì  ë¶„ì„ ëª¨ë“œ (DB ì—°ë™) ---
        function CumulativeAnalysisMode({ onComplete, onBack, db, onError }) {
            const [studentName, setStudentName] = useState('');
            const [reports, setReports] = useState([]);
            const [selectedReports, setSelectedReports] = useState(new Set());
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [step, setStep] = useState('search'); // 'search', 'select', 'analyzing'
            
            const { collection, query, where, getDocs } = window.firebase;

            const handleSearch = async () => {
                if (studentName.trim() === '') {
                    setError('í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                setIsLoading(true);
                setError('');
                try {
                    const reportsRef = collection(db, "reports");
                    const q = query(reportsRef, where("studentInfo.name", "==", studentName.trim()));
                    const querySnapshot = await getDocs(q);
                    const fetchedReports = [];
                    querySnapshot.forEach((doc) => {
                        fetchedReports.push({ id: doc.id, ...doc.data() });
                    });
                    
                    fetchedReports.sort((a,b) => new Date(b.studentInfo.date) - new Date(a.studentInfo.date));

                    if (fetchedReports.length === 0) {
                        setError(`'${studentName}' í•™ìƒì˜ ì €ì¥ëœ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                    } else {
                        setReports(fetchedReports);
                        setStep('select');
                    }
                } catch (e) {
                    console.error("Firestore ê²€ìƒ‰ ì˜¤ë¥˜:", e);
                    setError("ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    onError("ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                } finally {
                    setIsLoading(false);
                }
            };

            const handleReportToggle = (reportId) => {
                setSelectedReports(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(reportId)) {
                        newSet.delete(reportId);
                    } else {
                        newSet.add(reportId);
                    }
                    return newSet;
                });
            };
            
            const formatReportForAI = (report) => {
                const { studentInfo, growData } = report;
                return `
        --- ìƒë‹´ì¼: ${studentInfo.date}, ${studentInfo.session}íšŒì°¨ ---
        - ëª©í‘œ(Goal): ${growData.goal}
        - í˜„ì‹¤(Reality):
          - ê°•ì : ${growData.reality.strengths.join(', ')}
          - ì–´ë ¤ì›€: ${growData.reality.challenges.join(', ')}
        - ëŒ€ì•ˆ(Options): ${growData.options.join(', ')}
        - ì‹¤í–‰ê³„íš(Will): ${growData.will}
        `;
            };

            const analyzeWithAI = async () => {
                if (selectedReports.size === 0) {
                    setError('ë¶„ì„í•  ë¦¬í¬íŠ¸ë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                setIsLoading(true);
                setError('');
                setStep('analyzing');

                const contentToAnalyze = reports
                    .filter(r => selectedReports.has(r.id))
                    .sort((a, b) => new Date(a.studentInfo.date) - new Date(b.studentInfo.date))
                    .map(formatReportForAI)
                    .join('\n');

                const prompt = `
                    You are a helpful assistant for a school counselor.
                    The following text contains counseling records for a student, structured using the GROW model. Each record is separated by '--- ìƒë‹´ì¼ ---'.
                    Analyze all records cumulatively and provide a summary of the student's progress in Korean.
                    The analysis should be in Markdown format and include these sections:
                    1.  **ì¢…í•© ìš”ì•½ (Overall Summary):** Briefly summarize the student's entire counseling journey, highlighting key changes and growth points.
                    2.  **ëª©í‘œ(Goal)ì˜ ë³€í™”:** Analyze how the student's goals have evolved or become more specific over the sessions.
                    3.  **í•µì‹¬ ê°•ì  ë° ì•½ì  (Key Reality):** Identify recurring strengths and challenges observed across multiple sessions.
                    4.  **ì‹¤í–‰ ê³„íš(Will) í‰ê°€:** Evaluate the characteristics of the action plans and summarize any successes or difficulties in their implementation.

                    --- Counseling Records ---
                    ${contentToAnalyze}
                    --- End of Records ---
                `;

                try {
                    const apiKey = ""; // ì—¬ê¸°ì— Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                    const result = await response.json();
                    const analysisText = result.candidates[0].content.parts[0].text;
                    onComplete(analysisText);

                } catch (e) {
                    console.error("AI cumulative analysis error:", e);
                    setError("AI ëˆ„ì  ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    setStep('select');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="animate-fade-in">
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">ğŸ“ˆ ëˆ„ì  ë¶„ì„ ëª¨ë“œ</h2>
                    <p className="text-slate-600 mb-6">í•™ìƒ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì—¬ ì €ì¥ëœ ìƒë‹´ ë¦¬í¬íŠ¸ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                    
                    {step === 'search' && (
                        <div className="space-y-4">
                            <input 
                                type="text" 
                                placeholder="ë¶„ì„í•  í•™ìƒ ì´ë¦„ ì…ë ¥" 
                                value={studentName} 
                                onChange={(e) => setStudentName(e.target.value)} 
                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition"
                                onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                            />
                            {error && <p className="text-red-500 text-sm">{error}</p>}
                            <div className="flex flex-col md:flex-row gap-4 mt-4">
                                <button onClick={handleSearch} disabled={isLoading} className="w-full md:flex-1 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition disabled:bg-slate-400 disabled:cursor-wait">
                                    {isLoading ? 'ê²€ìƒ‰ ì¤‘...' : 'ë¦¬í¬íŠ¸ ê²€ìƒ‰'}
                                </button>
                                 <button onClick={onBack} className="w-full md:flex-1 bg-slate-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-700 transition">
                                    ğŸ  ì²˜ìŒìœ¼ë¡œ
                                </button>
                            </div>
                        </div>
                    )}

                    {step === 'select' && (
                        <div>
                            <h3 className="text-xl font-semibold text-slate-700 mb-4">'{studentName}' í•™ìƒ ë¦¬í¬íŠ¸ ëª©ë¡</h3>
                            <div className="space-y-2 max-h-60 overflow-y-auto bg-slate-50 p-3 rounded-lg border">
                                {reports.map(report => (
                                    <div key={report.id} className={`p-3 rounded-lg cursor-pointer transition ${selectedReports.has(report.id) ? 'bg-indigo-100 ring-2 ring-indigo-400' : 'bg-white hover:bg-indigo-50'}`} onClick={() => handleReportToggle(report.id)}>
                                        <label className="flex items-center cursor-pointer">
                                            <input type="checkbox" checked={selectedReports.has(report.id)} readOnly className="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                                            <span className="ml-3 font-medium text-slate-800">{report.studentInfo.session}íšŒì°¨ - {report.studentInfo.date}</span>
                                        </label>
                                    </div>
                                ))}
                            </div>
                            {error && <p className="text-red-500 text-sm mt-4">{error}</p>}
                             <div className="flex flex-col md:flex-row gap-4 mt-8">
                                <button onClick={analyzeWithAI} disabled={isLoading || selectedReports.size === 0} className="w-full md:flex-1 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition disabled:bg-slate-400 disabled:cursor-wait">
                                    {`ë¶„ì„ ì‹œì‘ (${selectedReports.size}ê°œ ì„ íƒë¨)`}
                                </button>
                                 <button onClick={() => { setStep('search'); setError(''); setReports([]); setSelectedReports(new Set()); }} className="w-full md:flex-1 bg-slate-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-700 transition">
                                    ë‹¤ë¥¸ í•™ìƒ ê²€ìƒ‰
                                </button>
                            </div>
                        </div>
                    )}
                     {step === 'analyzing' && (
                         <div className="text-center p-10">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                            <p className="mt-4 text-slate-600">ì„ íƒëœ ë¦¬í¬íŠ¸ë¥¼ AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
                        </div>
                    )}
                </div>
            );
        }


        // --- 5. ìµœì¢… ë¦¬í¬íŠ¸ í™”ë©´ ì»´í¬ë„ŒíŠ¸ ---
        function FinalReport({ data, onReset, onError, db }) {
            const [reportData, setReportData] = useState(data.growData);
            const [helpTarget, setHelpTarget] = useState(null);
            const [isHelpLoading, setIsHelpLoading] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [helpContent, setHelpContent] = useState('');
            
            const { collection, addDoc, serverTimestamp } = window.firebase;

            const handleFieldChange = (field, value) => {
                const keys = field.split('.');
                setReportData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev)); // Deep copy
                    let current = newData;
                    for (let i = 0; i < keys.length - 1; i++) {
                        current = current[keys[i]];
                    }
                    current[keys[keys.length - 1]] = value;
                    return newData;
                });
            };

            const handleArrayChange = (field, index, value) => {
                const keys = field.split('.');
                setReportData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev)); // Deep copy
                    let current = newData;
                    for (let i = 0; i < keys.length - 1; i++) {
                        current = current[keys[i]];
                    }
                    const newArray = [...current[keys[keys.length - 1]]];
                    newArray[index] = value;
                    current[keys[keys.length - 1]] = newArray;
                    return newData;
                });
            }

            const requestHelp = async (field, title, content) => {
                setHelpTarget({ field, title });
                setIsHelpLoading(true);
                setHelpContent('');

                const prompt = (Array.isArray(content) ? content.join(', ') : content).trim() === ''
                    ? `You are a helpful coaching assistant. The user is filling out the '${title}' section of a GROW model report. Please provide a concise, bullet-pointed guide in Korean on what kind of information should be written in this section. Include a good example.`
                    : `You are a helpful coaching assistant. The user is reviewing the '${title}' section of a GROW model report. The current content is: '${Array.isArray(content) ? content.join(', ') : content}'. Please review this content based on the principles of effective coaching and provide constructive feedback or suggestions for improvement in a concise, bullet-pointed list. Respond in Korean.`;

                try {
                    const apiKey = ""; // ì—¬ê¸°ì— Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                    const result = await response.json();
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    setHelpContent(aiResponse);

                } catch (e) {
                    console.error("AI Help error:", e);
                    setHelpContent("ë„ì›€ë§ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                } finally {
                    setIsHelpLoading(false);
                }
            };
            
            const handleSave = async (generatePdfAfterSave) => {
                setIsSaving(true);
                try {
                    const docRef = await addDoc(collection(db, "reports"), {
                        studentInfo: data.studentInfo,
                        growData: reportData,
                        createdAt: serverTimestamp()
                    });
                    console.log("ë¦¬í¬íŠ¸ ì €ì¥ ì„±ê³µ, ID: ", docRef.id);
                    if(generatePdfAfterSave) {
                        generatePdf();
                    } else {
                        alert("ë¦¬í¬íŠ¸ê°€ í´ë¼ìš°ë“œì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    }
                } catch (e) {
                    console.error("Firestore ì €ì¥ ì˜¤ë¥˜: ", e);
                    onError("ë¦¬í¬íŠ¸ë¥¼ í´ë¼ìš°ë“œì— ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                } finally {
                    setIsSaving(false);
                }
            };


            const generatePdf = () => {
                if (!window.jspdf || !window.jspdf.jsPDF || !window.jspdf.autoTable) {
                    onError("PDF ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì•„ì§ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    return;
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const { name, session, date } = data.studentInfo;
                const { goal, reality, options, will, nextSessionQuestions } = reportData;

                doc.addFileToVFS('D2Coding-normal.ttf', D2Coding);
                doc.addFont('D2Coding-normal.ttf', 'D2Coding', 'normal');
                doc.setFont('D2Coding');

                doc.setFontSize(22);
                doc.text('GROW ì½”ì¹­ ë¦¬í¬íŠ¸', 105, 20, { align: 'center' });

                doc.setFontSize(12);
                doc.text(`í•™ìƒ ì´ë¦„: ${name}`, 20, 40);
                doc.text(`ìƒë‹´ íšŒì°¨: ${session}íšŒì°¨`, 20, 48);
                doc.text(`ìƒë‹´ ì¼ì: ${date}`, 20, 56);

                const tableData = [
                    ['G (Goal)', goal],
                    ['R (Reality)', `ê°•ì : ${reality.strengths.join(', ')}\nì–´ë ¤ì›€: ${reality.challenges.join(', ')}`],
                    ['O (Options)', options.map(o => `- ${o}`).join('\n')],
                    ['W (Will)', will],
                ];
                
                if (nextSessionQuestions && nextSessionQuestions.length > 0) {
                    tableData.push(['ë‹¤ìŒ íšŒì°¨ ì§ˆë¬¸', nextSessionQuestions.map(q => `- ${q}`).join('\n')]);
                }


                doc.autoTable({
                    startY: 70,
                    head: [['í•­ëª©', 'ë‚´ìš©']],
                    body: tableData,
                    theme: 'grid',
                    styles: { font: 'D2Coding', cellPadding: 3, fontSize: 10 },
                    headStyles: { fillColor: [22, 160, 133], fontStyle: 'bold' },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 30 },
                        1: { cellWidth: 'auto' }
                    }
                });

                const filename = `${name}_${session}íšŒì°¨_${date.replace(/-/g, '')}.pdf`;
                doc.save(filename);
            };

            if (!reportData) {
                return <div className="text-center">ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
            }

            return (
                <div className="animate-fade-in">
                    {helpTarget && (
                        <HelpModal
                            title={helpTarget.title}
                            isLoading={isHelpLoading}
                            content={helpContent}
                            onClose={() => setHelpTarget(null)}
                        />
                    )}

                    <h2 className="text-2xl font-bold text-slate-800 mb-2">ìµœì¢… ë¦¬í¬íŠ¸ í™•ì¸</h2>
                    <p className="text-slate-500 mb-6">{data.studentInfo.name} í•™ìƒì˜ ìƒë‹´ ë‚´ìš©ì…ë‹ˆë‹¤. ì €ì¥ ì „ ë§ˆì§€ë§‰ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                    <div className="space-y-4">
                        <EditableField label="G (Goal) - ëª©í‘œ" value={reportData.goal} onHelpClick={() => requestHelp('goal', 'ëª©í‘œ (Goal)', reportData.goal)} onChange={e => handleFieldChange('goal', e.target.value)} isTextarea />
                        <div>
                            <div className="flex items-center justify-between">
                                <label className="font-bold text-slate-700">R (Reality) - í˜„ì‹¤ íŒŒì•…</label>
                                <HelpButton onClick={() => requestHelp('reality', 'í˜„ì‹¤ íŒŒì•… (Reality)', [...reportData.reality.strengths, ...reportData.reality.challenges])} />
                            </div>
                            <div className="p-3 mt-2 bg-slate-50 rounded-lg space-y-2">
                                <EditableField label="ê°•ì " value={reportData.reality.strengths.join(', ')} onChange={e => handleFieldChange('reality.strengths', e.target.value.split(',').map(s => s.trim()))} isSubfield />
                                <EditableField label="ì–´ë ¤ì›€" value={reportData.reality.challenges.join(', ')} onChange={e => handleFieldChange('reality.challenges', e.target.value.split(',').map(s => s.trim()))} isSubfield />
                            </div>
                        </div>
                        <div>
                            <div className="flex items-center justify-between">
                                <label className="font-bold text-slate-700">O (Options) - ëŒ€ì•ˆ íƒìƒ‰</label>
                                <HelpButton onClick={() => requestHelp('options', 'ëŒ€ì•ˆ íƒìƒ‰ (Options)', reportData.options)} />
                            </div>
                            {reportData.options.map((option, index) => (
                                <EditableField key={index} value={option} onChange={e => handleArrayChange('options', index, e.target.value)} isArray />
                            ))}
                        </div>
                        <EditableField label="W (Will) - ì‹¤í–‰ ê³„íš" value={reportData.will} onHelpClick={() => requestHelp('will', 'ì‹¤í–‰ ê³„íš (Will)', reportData.will)} onChange={e => handleFieldChange('will', e.target.value)} isTextarea />
                        
                        {reportData.nextSessionQuestions && reportData.nextSessionQuestions.length > 0 && (
                          <div className="mt-4">
                            <label className="font-bold text-slate-700">ğŸ’¡ ë‹¤ìŒ ìƒë‹´ì„ ìœ„í•œ ì¶”ì²œ ì§ˆë¬¸ (AI)</label>
                            <div className="p-3 mt-2 bg-indigo-50 rounded-lg space-y-2 border border-indigo-200">
                              {reportData.nextSessionQuestions.map((q, i) => (
                                <p key={i} className="text-slate-800 text-sm flex items-start">
                                  <span className="mr-2">âœ”ï¸</span>
                                  <span>{q}</span>
                                </p>
                              ))}
                            </div>
                          </div>
                        )}
                    </div>

                    <div className="flex flex-col md:flex-row gap-4 mt-8">
                         <button onClick={() => handleSave(true)} disabled={isSaving} className="w-full md:flex-1 bg-teal-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-700 transition disabled:bg-slate-400 disabled:cursor-wait">
                            {isSaving ? 'ì €ì¥ ì¤‘...' : 'â˜ï¸ í´ë¼ìš°ë“œì— ì €ì¥ & PDF ë‹¤ìš´ë¡œë“œ'}
                        </button>
                        <button onClick={onReset} className="w-full md:w-auto bg-slate-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-700 transition">
                            ğŸ  ì²˜ìŒìœ¼ë¡œ
                        </button>
                    </div>
                </div>
            );
        }

        // --- 6. ëˆ„ì  ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì»´í¬ë„ŒíŠ¸ ---
        function AnalysisReport({ result, onReset }) {
            const renderMarkdown = (text) => {
                let html = text
                    .replace(/^# (.*$)/gim, '<h2 class="text-2xl font-bold mt-8 mb-3 text-slate-900 border-b pb-2">$1</h2>')
                    .replace(/^## (.*$)/gim, '<h3 class="text-xl font-bold mt-6 mb-2 text-slate-800">$1</h3>')
                    .replace(/^### (.*$)/gim, '<h4 class="text-lg font-semibold mt-4 mb-1 text-slate-700">$1</h4>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/`([^`]+)`/g, '<code class="bg-slate-200 text-slate-800 rounded px-1 py-0.5">$1</code>')
                    .replace(/^- (.*$)/gim, '<li class="ml-5 list-disc">$1</li>')
                    .replace(/\n/g, '<br />');
                
                html = html.replace(/<br \s?\/?>(\s*<li)/g, '$1');
                html = html.replace(/(<\/li>)<br \s?\/?>/g, '$1');
                html = `<ul>${html}</ul>`.replace(/<\/ul><br \s?\/?><ul>/g, '');
                html = html.replace(/<\/strong><br \s?\/?>/g, '</strong>');

                return { __html: html };
            };

            return (
                <div className="animate-fade-in">
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">ğŸ“ˆ ëˆ„ì  ë¶„ì„ ë¦¬í¬íŠ¸</h2>
                    <p className="text-slate-500 mb-6">AIê°€ ë¶„ì„í•œ í•™ìƒì˜ ì„±ì¥ ê³¼ì • ìš”ì•½ì…ë‹ˆë‹¤.</p>

                    <div className="prose max-w-none p-4 bg-slate-50 rounded-lg border leading-relaxed" dangerouslySetInnerHTML={renderMarkdown(result || "ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")}>
                    </div>

                    <button onClick={onReset} className="w-full mt-8 bg-slate-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-700 transition">
                        ğŸ  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            );
        }


        // --- 7. ë„ì›€ë§ ì•„ì´ì½˜ ë° ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ ---
        const HelpButton = ({ onClick }) => (
            <button onClick={onClick} className="w-6 h-6 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center font-bold text-sm hover:bg-indigo-200 hover:text-indigo-700 transition">
                ?
            </button>
        );

        function HelpModal({ title, content, isLoading, onClose }) {
            const renderMarkdown = (text) => {
                let html = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^- (.*$)/gim, '<li>$1</li>')
                    .replace(/\n/g, '<br />');

                html = `<ul>${html}</ul>`.replace(/<\/ul><br \s?\/?><ul>/g, '');
                html = html.replace(/<br \s?\/?>(\s*<li)/g, '$1');
                html = html.replace(/(<\/li>)<br \s?\/?>/g, '$1');
                
                return { __html: html };
            }

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fade-in-fast">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-lg">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="text-lg font-bold text-indigo-700">ğŸ’¡ AI í—¬í¼: {title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
                        </div>
                        <div className="p-6 min-h-[150px]">
                            {isLoading ? (
                                <div className="flex items-center justify-center h-full">
                                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                                </div>
                            ) : (
                                <div className="text-slate-700 leading-relaxed prose max-w-none" dangerouslySetInnerHTML={renderMarkdown(content)}></div>
                            )}
                        </div>
                        <div className="p-4 bg-slate-50 border-t rounded-b-lg text-right">
                            <button onClick={onClose} className="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition">
                                ë‹«ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- 8. ìˆ˜ì • ê°€ëŠ¥í•œ í•„ë“œ ì»´í¬ë„ŒíŠ¸ ---
        function EditableField({ label, value, onChange, onHelpClick, isTextarea = false, isSubfield = false, isArray = false }) {
            const labelClass = isSubfield ? "font-semibold text-slate-600" : "font-bold text-slate-700";
            const inputClass = "w-full p-2 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 transition-all";

            const hasHelp = !!onHelpClick;

            return (
                <div className="w-full">
                    {label && (
                        <div className="flex items-center justify-between mb-1">
                            <label className={labelClass}>{label}</label>
                            {hasHelp && <HelpButton onClick={onHelpClick} />}
                        </div>
                    )}
                    {isTextarea ? (
                        <textarea value={value} onChange={onChange} className={inputClass} rows="3" />
                    ) : (
                        <input type="text" value={value} onChange={onChange} className={`${inputClass} ${isArray ? 'mt-2' : ''}`} />
                    )}
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
